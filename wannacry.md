# Ведется массовая атака криптором Wana decrypt0r 2.0

В настоящий момент можно наблюдать масштабную атаку трояном-декриптором "Wana decrypt0r 2.0". Атака наблюдается в разных сетях совершенно никак не связанных между cсобой.

![alt text](https://pbs.twimg.com/media/C_n2dzcW0AAsnG-.jpg:small "Wana decrypt0r 2.0 in action")

Некоторые компании советуют своим пользователям выключить свои компьютеры и ждать дальшейших инструкций.

![alt text](https://habrastorage.org/web/3cd/f32/c07/3cdf32c07c2f416085676d5e9e8c86fd.jpg)

Связавшись с бывшими коллегами я был удивлен похожими исторями.

Что касается меня, сегодня я подготавливал несколько новых образов Windows для нашей облачной системы, среди них был Windows Server 2008 R2.

Что самое интересное, стоило мне только установить Windows и настроить статический IP-адрес на ней, как сразу же в течении нескольких минут она была заражена.

![alt text](https://habrastorage.org/web/13d/e19/e3d/13de19e3d94c476f9ee223e1b28408f5.png)

Все образы Windows были получены из MSDN, хеши совпадают, так что возможность заражения образа исключена.

И это при том, что конфигурация файервола для единственного сетевого интерфейса смотрящего наружу, была настроена как "Общественная сеть".

Nmap не находит открытых портов. Вывод nmap показывает что даже в этом случае некоторые порты открыты наружу по умолчанию:

```
Host is up (0.017s latency).
Not shown: 997 filtered ports
PORT      STATE SERVICE
135/tcp   open  msrpc
445/tcp   open  microsoft-ds
49154/tcp open  unknown
```
Единственное что было установленно в системе — это Virtio-драйверы, которые были загруженны при установке самой Windows с внешнего CD.
ISO-образ был так же получен из официального источника — репозитория Fedora, хеш суммы так же совпадают.

~~На данный момент до конца не известно как именно произошло заражение и какие конкретно версии Windows уязвимы.~~

Если у вас есть похожие случаи, поделитесь информацией о них.

Несколько ссылок по теме:

- [Ссылка на Virustotal](https://virustotal.com/cs/file/b9c5d4339809e0ad9a00d4d3dd26fdf44a32819a54abf846bb9b560d81391c25/analysis/)
- [Информация на Mmalwr](https://malwr.com/analysis/ZWIxNWMzNzRhZmE5NDQ3OGIxODZjMzllNjYyZmJkZjY/)
- [Подробная информация о WannaCry на GitHub](https://gist.github.com/rain-1/989428fa5504f378b993ee6efbc0b168)
- [Анализ шифровальщика Wana Decrypt0r 2.0 от Pentestit](https://habrahabr.ru/company/pentestit/blog/328606/)

*остальные ссылки смотрите в комментариях к этой новости*

Ждем дальнеших новостей, всех с пятницей и вот вам нескушная обоина на рабочий стол:

![alt text](https://habrastorage.org/web/112/9e1/590/1129e15900d2411f9e311173d488b613.png "wana decrypt0r")

**UPD**: Судя по всему, для атаки используется уязвимость протокола SMBv1.

Патчи для исправления этой уязвимости можно скачатать на официальном сайте:

- [Microsoft Security Bulletin MS17-010](https://technet.microsoft.com/en-us/library/security/ms17-010.aspx)
- [Патч, для старых систем](https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/) (Windows XP, Winows Server 2003R2)

Уязвимость так-же можно закрыть, полностью отключив поддержку SMBv1. Для этого достаточно выполнить следующую команду в командной строке запущенной от имени Администратора (работает в Windows 8.1 и более старших версиях):

```
dism /online /norestart /disable-feature /featurename:SMB1Protocol
```
Установить патчи при этом все равно рекомендуется.

**UPD2**: По многочисленным просьбам добавляется информация о том как проверить стоит вам бояться или нет. Следующие действия помогут вам понять установлен ли патч закрывающий данную уязвимость в вашей системе:

- Перейдите по ссылке выше и проверьте код обновления для вышей системы, например для Windows 7 или Windows Server 2008 R2, код будет `4012212` или `4012215`
- Откройте `cmd.exe` (командную строку)
- Напишите:
```
wmic qfe list | findstr 4012212
```
- Нажмите Enter
- Если в ответе вы увидите что-то подобное, это значит что патч у вас уже установлен и можно спать спокойно:
```
http://support.microsoft.com/?kbid=4012212 P2 Security Update KB4012212 NT AUTHORITY\система 3/18/2017
```
- Если же ответ вернет вам пустую строку, попробуйте проверить следующий патч из списка
- Если ни один патч не находится, рекомендуется незамедлительно установить обновление по ссылке выше или по прямой ссылке из [UPD9](https://geektimes.ru/post/289115/#UPD9)

*Как выяснилось этот метод не на 100% рабочий и у каждого могут быть свои ньюансы.
Если вы все же уверены что обновление безопасности у вас установлено, а в ответ вы по прежнему получаете пустую строку, попробуйте проверить обновление через журнал обновлений Windows или почитать комментарии к этой статье.*

**UPD3**: В интернете [находятся](http://searchengines.guru/showpost.php?s=6701b6716ad6128df6c2518a7134354a&p=15047229&postcount=7) интересные подробности по данному инциденту:

> Да, так и есть. Появился набор эксплоитов FuzzBunch, который группа хакеров Shadow Brokers украла у Equation Group, хакеров из Агенства Нац. Безопасности США.
> Microsoft потихому прикрыла дырки обновлением MS 17-010, возможно самым важным обновлением за последние десять лет.
> В то время как набор эксплоитов уже неделю лежит в открытом доступе [здесь](https://github.com/fuzzbunch/fuzzbunch) с обучающими видео.
> В этом наборе есть опасный инструмент DoublePulsar.
> Если кратко, то если открыт 445 порт и не установлено обновление MS 17-010, то DoublePulsar
> простукивает этот порт, делает перехваты системных вызовов и в память внедряет вредоносный код.

**UPD4**: Интерактивная карта заражения:

[![alt text](https://habrastorage.org/web/79e/c8e/12f/79ec8e12fdb441a6ae6e5c0e8820ca37.png "Wana Decrypt0r interactive map")](https://intel.malwaretech.com/botnet/wcrypt)

**UPD5**: Видео показывающее наглядное применение эксплойта:

[![alt text](https://pbs.twimg.com/ext_tw_video_thumb/852958542545997824/pu/img/oU2SJiDKMYyKRatR.jpg)](https://twitter.com/hackerfantastic/status/852958717746315264)

**UPD6**: Нашелся интересный изъян в коде:

> Распространение вируса-вымогателя WannaCrypt удалось приостановить, зерегистрировав домен iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com.
> Специалист по безопасности, который ведет твиттер @MalwareTechBlog, обнаружил, что вирус зачем-то обращается к этому домену и решил зарегистрировать его, чтобы следить за активностью программы.
>
> Как выяснилось потом, в коде вируса говорилось, что если обращение к этому домену успешно, то заражение следует прекратить; если нет, то продолжать. Сразу после регистрации домена, к нему пришли десятки тысяч запросов.
> 
> Вирус-вымогатель начал распространяться 12 мая. Он блокирует компьютер и требует 300 долларов за разблокировку. Десятки тысяч заражений зарегистрировали в 99 странах, в том числе в России, где жертвами стали «Мегафон», МВД и СК. В других странах пострадали телекоммуникационные компании, банки, консалтинговые фирмы. В Великобритании из строя вышли компьютеры системы здравоохранения.
> Регистрация вышеупомянутого домена не помогла тем, кто уже был заражен, но дала время другим установить обновление Windows, после которого вирус не работает.

**UPD7**: Microsoft выпустил [патч для старых систем](https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/) (Windows XP и Windows Server 2003R2)

**UPD8**: [Копипаста](https://2ch.hk/b/res/152977799.html) с 2ch.hk

> У тех кто начал эту атаку есть
> > Эксплойты слитые Shadow brokers
> > Сканнер сети который они сами написали на C/Python
> > Linux сервер
> 
> Как это работает?
> > Скрипт сканнера запускается на Linux сервере
> > Вбивается определенный IP диапазон или целая страна
> > Скрипт сканирует диапазон на открытый 445 порт
> > В случае удачного обнаружения SMB сервиса, посылает эксплойт, вызывающий переполнение буфера 
> > эксплойт закачивает файл и запускает его.

**UPD9**: здесь должны были быть официальные прямые ссылки на этот патч для различных систем:

**UPD10**: Появились версии шифровальщика игнорирующие killswitch метод описанный в [UPD6](https://geektimes.ru/post/289115/#UPD6).
